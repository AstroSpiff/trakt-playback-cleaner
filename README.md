<<<<<<< ours
[üá¨üáß ENG](README.md) | [üáÆüáπ ITA](README_ITA.md)
=======
[üá¨üáß English](#) | [üáÆüáπ Italiano](README_ITA.md)
>>>>>>> theirs

# Trakt Playback Cleaner

Automate Trakt playback cleanup via GitHub Actions. The system automatically handles OAuth2 token refresh and periodic playback cleanup.

## Features

- üîÑ **Auto-refresh tokens**: automatic renewal every 12 hours
- üßπ **Automatic cleanup**: playback removal every 30 minutes
- üîê **Security**: tokens masked in logs, no sensitive data exposed
- ‚öôÔ∏è **Zero maintenance**: fully automated

## Requirements

- A GitHub account (for GitHub Actions)
- A Trakt app with `sync` permissions
- Python 3.11+ (for local use only)

## Quick Setup

### 1. Create a Trakt App

1. Go to https://trakt.tv/oauth/applications
2. Click "New Application"
3. Fill in the required fields:
   - **Redirect URI**: `urn:ietf:wg:oauth:2.0:oob`
   - **Permissions**: select `sync`
4. Save the application and note down `Client ID` and `Client Secret`

### 2. Get the Refresh Token

Open in your browser (replace `YOUR_CLIENT_ID` with your Client ID):

```
https://trakt.tv/oauth/authorize?response_type=code&client_id=YOUR_CLIENT_ID&redirect_uri=urn:ietf:wg:oauth:2.0:oob&scope=sync&state=xyz
```

Authorize the app and copy the **code** that appears.

Then run this command (replace the values):

```bash
curl -s -X POST https://api.trakt.tv/oauth/token \
  -H "Content-Type: application/json" \
  -d '{
    "code":"THE_CODE_YOU_COPIED",
    "client_id":"YOUR_CLIENT_ID",
    "client_secret":"YOUR_CLIENT_SECRET",
    "redirect_uri":"urn:ietf:wg:oauth:2.0:oob",
    "grant_type":"authorization_code"
  }'
```

From the JSON response, copy the `refresh_token` value.

### 3. Create a GitHub Personal Access Token (PAT)

The PAT is required to allow workflows to automatically update secrets.

1. Go to GitHub ‚Üí Settings ‚Üí Developer settings ‚Üí Personal access tokens ‚Üí Tokens (classic)
2. Click "Generate new token (classic)"
3. Assign a name (e.g., "Trakt Playback Cleaner")
4. Select the `repo` scope (full access to private repositories)
5. Click "Generate token" and copy the generated token

**Or** use a Fine-grained token:
1. Go to Personal access tokens ‚Üí Fine-grained tokens
2. Create a token with access to the specific repository
3. Required permissions: "Secrets" ‚Üí Read and write

### 4. Configure Secrets on GitHub

1. Open your repository on GitHub
2. Go to **Settings** ‚Üí **Secrets and variables** ‚Üí **Actions**
3. Click **New repository secret** and add the following secrets:

| Name | Value | Description |
|------|-------|-------------|
| `TRAKT_CLIENT_ID` | Your Client ID | Trakt app ID |
| `TRAKT_CLIENT_SECRET` | Your Client Secret | Trakt app secret |
| `TRAKT_REFRESH_TOKEN` | The refresh token obtained | Token to renew access |
| `GH_PAT` | Your Personal Access Token | Allows automatic secret updates |

**Note**: You don't need to manually create `TRAKT_ACCESS_TOKEN` - it will be automatically generated by the "Refresh Trakt Token" workflow.

### 5. Start the First Refresh

1. Go to **Actions** in your repository
2. Select the **"Refresh Trakt Token"** workflow
3. Click **Run workflow** ‚Üí **Run workflow**
4. Wait for completion (about 1 minute)

This will generate and automatically save the first `TRAKT_ACCESS_TOKEN`.

### 6. Verify Everything Works

1. Manually run the **"Trakt Playback Cleaner"** workflow
2. Check the logs to verify there are no errors
3. You should see: `Nessun playback da cancellare.` (if you have no active playbacks)

## How It Works

### "Refresh Trakt Token" Workflow

- **Schedule**: every 12 hours (automatic)
- **Function**: renews access and refresh tokens
- **Output**: automatically updates `TRAKT_ACCESS_TOKEN` and `TRAKT_REFRESH_TOKEN` secrets

The workflow:
1. Uses the saved `TRAKT_REFRESH_TOKEN` to obtain new tokens
2. Masks tokens in logs for security
3. Saves new tokens to secrets via GitHub CLI

### "Trakt Playback Cleaner" Workflow

- **Schedule**: every 30 minutes (automatic)
- **Function**: removes all in-progress playbacks on Trakt
- **Output**: log of the number of deleted playbacks

The workflow uses `TRAKT_ACCESS_TOKEN` to authenticate and remove playbacks via the `/sync/playback` API.

## Modify the Schedule

You can change workflow frequency by editing files in `.github/workflows/`:

**Refresh Trakt Token** (`.github/workflows/refresh-token.yml`):
```yaml
schedule:
  - cron: '0 */12 * * *'  # Every 12 hours
```

**Trakt Playback Cleaner** (`.github/workflows/trakt-playback-cleaner.yml`):
```yaml
schedule:
  - cron: '*/30 * * * *'  # Every 30 minutes
```

Use [crontab.guru](https://crontab.guru/) to create your custom schedule.

## Local Usage (Optional)

If you want to test the scripts locally:

### Install Dependencies

```bash
pip install -r requirements.txt
```

### Manual Token Refresh

```bash
export TRAKT_CLIENT_ID="your_client_id"
export TRAKT_CLIENT_SECRET="your_client_secret"
export TRAKT_REFRESH_TOKEN="your_refresh_token"
python refresh_token.py
```

Output:
```json
{"access_token":"...","refresh_token":"...","expires_in":7776000,...}
```

### Manual Playback Cleanup

```bash
export TRAKT_CLIENT_ID="your_client_id"
export TRAKT_ACCESS_TOKEN="access_token_from_previous_output"
python clear_playback.py
```

## Configuration Variables (Optional)

You can customize behavior via environment variables:

| Variable | Default | Description |
|----------|---------|-------------|
| `TRAKT_REQUEST_TIMEOUT` | `10` | HTTP request timeout (seconds) |
| `TRAKT_MAX_RETRIES` | `3` | Maximum number of retries |
| `TRAKT_RETRY_BASE_SECONDS` | `1` | Base time between retries (seconds) |
| `TRAKT_REDIRECT_URI` | `urn:ietf:wg:oauth:2.0:oob` | OAuth2 redirect URI |

## Troubleshooting

### `invalid_grant` Error

**Cause**: The refresh token is expired, revoked, or invalid.

**Solution**:
1. Revoke app access at https://trakt.tv/oauth/authorized_applications
2. Generate a new refresh token (see "Get the Refresh Token" section)
3. Update the `TRAKT_REFRESH_TOKEN` secret on GitHub
4. Manually run "Refresh Trakt Token"

### `401 Unauthorized` Error

**Cause**: The access token is invalid or expired.

**Solution**:
1. Manually run the "Refresh Trakt Token" workflow
2. Verify that the `TRAKT_ACCESS_TOKEN` secret was created
3. Retry "Trakt Playback Cleaner"

### `redirect_uri mismatch` Error

**Cause**: The redirect URI doesn't match the one configured in the Trakt app.

**Solution**:
1. Verify that the Redirect URI in the Trakt app is: `urn:ietf:wg:oauth:2.0:oob`
2. Use the same URI when generating the refresh token

### Workflows Don't Start Automatically

**Cause**: GitHub Actions might be disabled or workflows don't have permissions.

**Solution**:
1. Go to **Settings** ‚Üí **Actions** ‚Üí **General**
2. Verify that "Allow all actions and reusable workflows" is selected
3. In "Workflow permissions", make sure workflows have the necessary permissions

## Security

- ‚úÖ All tokens are masked in logs with `::add-mask::`
- ‚úÖ Secrets are encrypted by GitHub
- ‚úÖ No sensitive data is ever committed to the repository
- ‚úÖ The `GH_PAT` only has access to repository secrets

## License

This project is provided "as is" without warranties. Use at your own risk.

---

üáÆüáπ [Versione italiana](README_ITA.md)
