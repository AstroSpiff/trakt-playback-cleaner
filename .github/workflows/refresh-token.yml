name: Refresh Trakt Token

on:
  schedule:
    - cron: '0 */12 * * *'  # Ogni 12 ore; modifica se necessario
  workflow_dispatch:

jobs:
  refresh:
    runs-on: ubuntu-latest
    outputs:
      new_access_token: ${{ steps.get-tokens.outputs.new_access_token }}
      new_refresh_token: ${{ steps.get-tokens.outputs.new_refresh_token }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          pip install requests jq

      - name: Get new tokens
        id: get-tokens
        env:
          TRAKT_CLIENT_ID: ${{ secrets.TRAKT_CLIENT_ID }}
          TRAKT_CLIENT_SECRET: ${{ secrets.TRAKT_CLIENT_SECRET }}
          TRAKT_REFRESH_TOKEN: ${{ secrets.TRAKT_REFRESH_TOKEN }}
        run: |
          python refresh_token.py > tokens.json
          NEW_ACCESS_TOKEN=$(jq -r '.access_token' tokens.json)
          NEW_REFRESH_TOKEN=$(jq -r '.refresh_token' tokens.json)
          echo "Nuovo Access Token: $NEW_ACCESS_TOKEN"
          echo "Nuovo Refresh Token: $NEW_REFRESH_TOKEN"
          # Imposta gli output tramite il file d'ambiente
          echo "new_access_token=$NEW_ACCESS_TOKEN" >> $GITHUB_OUTPUT
          echo "new_refresh_token=$NEW_REFRESH_TOKEN" >> $GITHUB_OUTPUT

      - name: Update TRAKT_ACCESS_TOKEN secret using GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.REPO_ADMIN_TOKEN }}
        run: |
          gh secret set TRAKT_ACCESS_TOKEN --body "${{ steps.get-tokens.outputs.new_access_token }}"

      - name: Update TRAKT_REFRESH_TOKEN secret using GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.REPO_ADMIN_TOKEN }}
        run: |
          gh secret set TRAKT_REFRESH_TOKEN --body "${{ steps.get-tokens.outputs.new_refresh_token }}"
